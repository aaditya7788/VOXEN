# Deploying Voxen to AWS EC2

This guide outlines the steps to deploy the Voxen Frontend and Backend to an AWS EC2 instance using Nginx as a reverse proxy and PM2 for process management.

## 1. AWS EC2 Setup (Console)

1.  **Launch Instance**:
    -   **OS**: Ubuntu 24.04 LTS (recommended).
    -   **Instance Type**: t3.small or t3.medium (Next.js builds require ~2GB+ RAM).
    -   **Security Group**: Allow **SSH (22)**, **HTTP (80)**, and **HTTPS (443)**.
2.  **Elastic IP**: Allocate and associate an Elastic IP to your instance so the IP doesn't change on reboot.
3.  **DNS**: Point your domain (e.g., `voxen.example.com`) to the Elastic IP.

---

## 2. Server Preparation

Connect to your instance via SSH:
```bash
ssh -i "your-key.pem" ubuntu@your-instance-ip
```

Run the following setup script to install Node.js, PM2, and Nginx:

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Install PM2 and production tools
sudo npm install -g pm2
sudo apt install -y nginx certbot python3-certbot-nginx
```

---

## 3. Deployment Steps

### A. Clone and Setup
```bash
git clone <your-repo-url> voxen
cd voxen
```

### B. Configure Backend
```bash
cd Backend
npm install
# Create .env and add your variables
nano .env 
# Build/Start
pm2 start src/index.js --name voxen-backend
```

### C. Configure Frontend
```bash
cd ../frontend
npm install
# Create .env.local and add your variables
nano .env.local
# Set NEXT_PUBLIC_URL to your domain (e.g., https://voxen.yourdomain.com)
npm run build
pm2 start npm --name voxen-frontend -- start
```

---

## 4. Nginx Configuration (Reverse Proxy)

Create a configuration file:
```bash
sudo nano /etc/nginx/sites-available/voxen
```

Paste the following (replace `yourdomain.com` with your actual domain):

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # Frontend
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Backend API
    location /api/v1 {
        proxy_pass http://localhost:4000; # Updated to match your backend .env
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Websockets (if needed)
    location /socket.io {
        proxy_pass http://localhost:4000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
}
```

Enable the configuration:
```bash
sudo ln -s /etc/nginx/sites-available/voxen /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

## 5. SSL with Let's Encrypt (CRITICAL for Mini Apps)

Farcaster Mini Apps **require** HTTPS. Run Certbot:

```bash
sudo certbot --nginx -d yourdomain.com
```

Certbot will automatically update your Nginx config to handle SSL.

---

## 6. PM2 Persistence
Ensure your apps restart on server reboot:
```bash
pm2 save
pm2 startup
# Run the command generated by the output of the line above
```
